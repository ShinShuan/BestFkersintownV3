<!-- Intégration modulaire de votre boutique personnalisée dans Shopify -->
<!-- Ajoutez ce code dans votre fichier index.liquid -->

{% comment %}
  Configuration modulaire pour l'intégration
  Vous pouvez activer/désactiver différentes parties
{% endcomment %}

{% assign enable_custom_header = true %}
{% assign enable_custom_products = true %}
{% assign enable_custom_cart = true %}
{% assign custom_shop_url = 'http://localhost:3000' %}

<style>
  /* Styles pour l'intégration modulaire */
  .custom-shop-module {
    margin: 20px 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .custom-shop-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    text-align: center;
  }
  
  .custom-shop-header h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: bold;
  }
  
  .custom-shop-header p {
    margin: 10px 0 0 0;
    opacity: 0.9;
  }
  
  .custom-shop-content {
    min-height: 600px;
    border: none;
    width: 100%;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .custom-shop-header h1 {
      font-size: 1.5rem;
    }
    
    .custom-shop-content {
      min-height: 400px;
    }
  }
  
  /* Animation de chargement */
  .loading-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    background: #f8f9fa;
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<!-- Module Header Personnalisé -->
{% if enable_custom_header %}
<div class="custom-shop-module">
  <div class="custom-shop-header">
    <h1>BestF.kersInTown</h1>
    <p>Boutique Personnalisée - Découvrez nos produits exclusifs</p>
  </div>
</div>
{% endif %}

<!-- Module Produits Personnalisés -->
{% if enable_custom_products %}
<div class="custom-shop-module">
  <div class="loading-placeholder" id="productsLoading">
    <div class="loading-spinner"></div>
  </div>
  
  <iframe 
    src="{{ custom_shop_url }}/products"
    class="custom-shop-content"
    title="Produits BestF.kersInTown"
    id="productsFrame"
    style="display: none;"
    allow="payment; camera; microphone; geolocation"
    sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox">
  </iframe>
</div>
{% endif %}

<!-- Module Panier Personnalisé -->
{% if enable_custom_cart %}
<div class="custom-shop-module">
  <div class="loading-placeholder" id="cartLoading">
    <div class="loading-spinner"></div>
  </div>
  
  <iframe 
    src="{{ custom_shop_url }}/cart"
    class="custom-shop-content"
    title="Panier BestF.kersInTown"
    id="cartFrame"
    style="display: none;"
    allow="payment; camera; microphone; geolocation"
    sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox">
  </iframe>
</div>
{% endif %}

<script>
  // Configuration de l'intégration modulaire
  const MODULE_CONFIG = {
    customShopUrl: '{{ custom_shop_url }}',
    shopifyStoreUrl: '{{ shop.url }}',
    modules: {
      header: {{ enable_custom_header }},
      products: {{ enable_custom_products }},
      cart: {{ enable_custom_cart }}
    }
  };
  
  // Gestionnaire de chargement des iframes
  function handleIframeLoad(iframeId, loadingId) {
    const iframe = document.getElementById(iframeId);
    const loading = document.getElementById(loadingId);
    
    if (iframe && loading) {
      iframe.onload = function() {
        loading.style.display = 'none';
        iframe.style.display = 'block';
        
        // Notifier que le module est chargé
        postMessageToIframe(iframe, {
          type: 'MODULE_LOADED',
          data: { module: iframeId }
        });
      };
    }
  }
  
  // Gestionnaire de messages
  window.addEventListener('message', function(event) {
    if (event.origin !== MODULE_CONFIG.customShopUrl) return;
    
    const { type, data } = event.data;
    
    switch(type) {
      case 'ADD_TO_SHOPIFY_CART':
        addToShopifyCart(data);
        break;
        
      case 'GO_TO_SHOPIFY_CHECKOUT':
        goToShopifyCheckout();
        break;
        
      case 'SYNC_CART':
        syncCartWithShopify(data);
        break;
        
      case 'PRODUCT_CLICK':
        handleProductClick(data);
        break;
        
      default:
        console.log('Message reçu:', event.data);
    }
  });
  
  // Fonctions utilitaires
  function postMessageToIframe(iframe, message) {
    if (iframe && iframe.contentWindow) {
      iframe.contentWindow.postMessage(message, MODULE_CONFIG.customShopUrl);
    }
  }
  
  async function addToShopifyCart(productData) {
    try {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          items: [{
            id: productData.variantId,
            quantity: productData.quantity || 1
          }]
        })
      });
      
      if (response.ok) {
        // Notifier le succès
        notifyAllIframes({
          type: 'SHOPIFY_CART_UPDATED',
          data: { success: true }
        });
      }
    } catch (error) {
      console.error('Erreur ajout au panier Shopify:', error);
    }
  }
  
  function goToShopifyCheckout() {
    window.location.href = '/cart';
  }
  
  function syncCartWithShopify(cartData) {
    // Synchroniser le panier personnalisé avec Shopify
    console.log('Synchronisation panier:', cartData);
  }
  
  function handleProductClick(productData) {
    // Gérer les clics sur les produits
    console.log('Produit cliqué:', productData);
  }
  
  function notifyAllIframes(message) {
    const iframes = document.querySelectorAll('iframe');
    iframes.forEach(iframe => {
      postMessageToIframe(iframe, message);
    });
  }
  
  // Initialisation
  document.addEventListener('DOMContentLoaded', function() {
    // Configurer les iframes
    if (MODULE_CONFIG.modules.products) {
      handleIframeLoad('productsFrame', 'productsLoading');
    }
    
    if (MODULE_CONFIG.modules.cart) {
      handleIframeLoad('cartFrame', 'cartLoading');
    }
    
    // Envoyer la configuration à tous les modules
    setTimeout(() => {
      notifyAllIframes({
        type: 'SHOPIFY_CONFIG',
        data: {
          storeUrl: MODULE_CONFIG.shopifyStoreUrl,
          modules: MODULE_CONFIG.modules
        }
      });
    }, 2000);
  });
</script>

