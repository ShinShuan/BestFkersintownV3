<!-- Intégration complète de votre boutique personnalisée dans Shopify -->
<!-- Remplacez complètement le contenu de votre index.liquid -->

{% comment %}
  Configuration de l'intégration
  Remplacez ces variables par vos vraies valeurs
{% endcomment %}

{% assign custom_shop_url = 'http://localhost:3000' %}
{% assign shopify_store_url = shop.url %}
{% assign shopify_access_token = 'VOTRE_ACCESS_TOKEN' %}

<style>
  /* Reset complet pour l'intégration */
  body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  
  .integration-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
  }
  
  .custom-shop-frame {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }
  
  /* Masquer tous les éléments Shopify */
  .site-header,
  .site-footer,
  .main-content,
  .page-width,
  .section-header {
    display: none !important;
  }
  
  /* Overlay de chargement */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.3s ease;
  }
  
  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }
  
  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<!-- Overlay de chargement -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
</div>

<!-- Container principal -->
<div class="integration-container">
  <iframe 
    src="{{ custom_shop_url }}"
    class="custom-shop-frame"
    title="BestF.kersInTown - Boutique Intégrée"
    allow="payment; camera; microphone; geolocation; fullscreen"
    sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation">
  </iframe>
</div>

<script>
  // Configuration de l'intégration
  const CONFIG = {
    customShopUrl: '{{ custom_shop_url }}',
    shopifyStoreUrl: '{{ shopify_store_url }}',
    shopifyAccessToken: '{{ shopify_access_token }}',
    shopifyApiVersion: '2024-01'
  };
  
  // Gestionnaire de messages pour la communication entre les applications
  window.addEventListener('message', function(event) {
    // Vérifier l'origine pour la sécurité
    if (event.origin !== CONFIG.customShopUrl) return;
    
    const { type, data } = event.data;
    
    switch(type) {
      case 'ADD_TO_CART':
        handleAddToCart(data);
        break;
        
      case 'CHECKOUT':
        handleCheckout(data);
        break;
        
      case 'PRODUCT_SYNC':
        handleProductSync(data);
        break;
        
      case 'CART_SYNC':
        handleCartSync(data);
        break;
        
      case 'LOADED':
        hideLoadingOverlay();
        break;
        
      default:
        console.log('Message reçu:', event.data);
    }
  });
  
  // Fonctions de gestion des événements
  async function handleAddToCart(productData) {
    try {
      // Ajouter au panier Shopify via l'API
      const response = await fetch(`/cart/add.js`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          items: [{
            id: productData.variantId,
            quantity: productData.quantity
          }]
        })
      });
      
      if (response.ok) {
        // Notifier votre application du succès
        postMessageToCustomShop({
          type: 'CART_ADDED_SUCCESS',
          data: { success: true }
        });
      }
    } catch (error) {
      console.error('Erreur lors de l\'ajout au panier:', error);
    }
  }
  
  function handleCheckout(checkoutData) {
    // Rediriger vers le checkout Shopify
    window.location.href = '/cart';
  }
  
  async function handleProductSync(productData) {
    // Synchroniser les données produit avec Shopify
    console.log('Synchronisation produit:', productData);
  }
  
  function handleCartSync(cartData) {
    // Synchroniser le panier
    console.log('Synchronisation panier:', cartData);
  }
  
  function hideLoadingOverlay() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.classList.add('hidden');
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 300);
    }
  }
  
  function postMessageToCustomShop(message) {
    const iframe = document.querySelector('.custom-shop-frame');
    if (iframe && iframe.contentWindow) {
      iframe.contentWindow.postMessage(message, CONFIG.customShopUrl);
    }
  }
  
  // Initialisation
  document.addEventListener('DOMContentLoaded', function() {
    // Masquer l'overlay après 3 secondes maximum
    setTimeout(hideLoadingOverlay, 3000);
    
    // Envoyer la configuration à votre application
    setTimeout(() => {
      postMessageToCustomShop({
        type: 'SHOPIFY_CONFIG',
        data: {
          storeUrl: CONFIG.shopifyStoreUrl,
          apiVersion: CONFIG.shopifyApiVersion
        }
      });
    }, 1000);
  });
</script>

